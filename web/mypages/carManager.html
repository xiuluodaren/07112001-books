<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>

    <meta charset="utf-8">

    <title>车辆管理</title>
    <!--引入相关的js文件-->
    <link href="../backPage/ui/bootstrap-3.3.0/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../backPage/ui/bootstrap-table-1.11.0/bootstrap-table.min.css" rel="stylesheet"/>
    <link href="../backPage/ui/waves-0.7.5/waves.css" rel="stylesheet"/>
    <link href="../backPage/ui/jquery-confirm/jquery-confirm.min.css" rel="stylesheet"/>
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet"/>

    <script src="../backPage/ui/js/jquery-3.3.1.min.js"></script>
    <script src="../backPage/ui/waves-0.7.5/waves.js"></script>
    <script src="../backPage/ui/jquery-confirm/jquery-confirm.min.js"></script>
    <script src="../backPage/ui/bootstrap-3.3.0/js/bootstrap.min.js"></script>
    <script src="../backPage/ui/bootstrap-table-1.11.0/bootstrap-table.min.js"></script>
</head>

<body>
<div id="main">
    <div id="toolbar">
        <button class="btn btn-default" href="javascript:;" onclick="createAction()">新增车辆信息</button>
        <button class="btn btn-default" href="javascript:;" onclick="updateAction()">编辑车辆信息</button>
        <button class="btn btn-default" href="javascript:;" onclick="deleteAction()">删除车辆信息</button>
        <br/>
    </div>
    <table id="table"></table>
</div>

<script>
    // 初始化input特效
    function initMaterialInput() {
        $('form input[type="text"]').each(function () {
            if ($(this).val() != '') {
                $(this).parent().find('label').addClass('active');
            }
        });
    }

    var $table = $('#table');

    $(function() {

        $("#carType").empty();
        $.ajax({
            url:"/carType?method=find",
            type:"post",
            success:function(data){
                for(var i = 0;i<data.rows.length;i++){
                    $("#carType").append("<option typeName='"+data.rows[i]['typeName']+"' value="+data.rows[i]['id']+">"+data.rows[i]['typeName']+"</option>")
                }
            }
        });

        //新增车辆信息
        $("#submitbutton").click(function() {
            var id = $("#carId").val()
            var carName = $("#carName").val()
            var state = $("#state").val()
            var carTypeId = $("#carType").val()
            var carTypeName = $("#carType option[value='"+carTypeId+"']").attr("typeName");

            var url = "/car?method=";

            if (id != null && id != "")
            {
                url += "update&id=" + id;
            }else{
                url += "create";
            }

            url += "&carName=" + carName + "&state=" + state + "&carTypeId=" + carTypeId + "&carTypeName=" + carTypeName;

            $.ajax({
                url:url,
                type:"post",
                contentType: "application/json;charset=UTF-8",
                success:function(data){
                    if(data.success == true){
                        alert("保存成功");
                        $table.bootstrapTable('refresh');
                        $('form')[0].reset();
                        $("#createModal").modal('hide');
                    }else{
                        alert(data.errMsg);
                    }
                }
            })

        })

        // bootstrap table初始化
        $table.bootstrapTable({
            url: '/car?method=find',
            height: getHeight(),
            toolbar: '#toolbar',
            clickToSelect: true,
            striped: true,
            showRefresh: true,
            showColumns: true,
            minimumCountColumns: 2,
            paginationLoop: false,
            sidePagination: 'server',
            silentSort: false,
            sortOrder: "desc",
            smartDisplay: false,
            escape: true,
            idField: 'id',
            maintainSelected: true,
            columns: [
                {field: 'ck', checkbox: true},
                {field: 'id', title: '编号', align: 'center'},
                {field: 'carName', title: '车辆名称',align: 'center'},
                {field: 'state', title: '车辆状态',align: 'center',
                    formatter:function(value, row, index){
                        if (value == 0)
                        {
                            return "未出租";
                        }else{
                            return "已出租";
                        }
                    }},
                {field: 'carTypeName', title: '车辆类型',align: 'center'},
                {field: 'action', title: '操作', align: 'center', formatter: 'actionFormatter', events: 'actionEvents', clickToSelect: false}
            ],
            onLoadError:function (status, res){
                console.info(status);
                console.info(res);
                var url = window.location.protocol + "//" + window.location.host + "/";
                parent.window.location.href = url;
            },
            onLoadSuccess:function (data){
                console.info(data);
            },
        });
    });

    // 格式化操作按钮
    function actionFormatter(value, row, index) {
        return [
            '<a class="update" href="javascript:;" onclick="updateAction()" data-toggle="tooltip" title="编辑"><i class="glyphicon glyphicon-edit"></i></a>　',
            '<a class="delete" href="javascript:;" onclick="deleteAction()" data-toggle="tooltip" title="删除"><i class="glyphicon glyphicon-remove"></i></a>'
        ].join('');
    }
    // 格式化时间
    function timeFormatter(value , row, index) {
        return new Date(value).toLocaleString().split(' ')[0];
    }

    function getHeight() {
        return $(window).height() - 20;
    }

    // 删除
    var deleteDialog;
    function deleteAction() {
        var rows = $table.bootstrapTable('getSelections');
        if (rows.length == 0) {
            $.confirm({
                title: false,
                content: '请至少选择一条记录！',
                autoClose: 'cancel|3000',
                backgroundDismiss: true,
                buttons: {
                    cancel: {
                        text: '取消',
                        btnClass: 'waves-effect waves-button'
                    }
                }
            });
        } else {
            deleteDialog = $.confirm({
                type: 'red',
                animationSpeed: 300,
                title: false,
                content: '确认删除该车辆信息吗？',
                buttons: {
                    confirm: {
                        text: '确认',
                        btnClass: 'waves-effect waves-button',
                        action: function () {
                            var ids = new Array();
                            for (var i in rows) {
                                ids.push(rows[i].id);
                            }

                            $.ajax({
                                url:"/car?method=delete&ids="+ids.join("-"),
                                type:"post",
                                contentType: "application/json;charset=UTF-8",
                                success:function(data){
                                    if(data.success == true){
                                        alert("成功");
                                        $table.bootstrapTable('refresh');
                                        $('form')[0].reset();
                                        $("#createModal").modal('hide');
                                    }else{
                                        alert("失败");
                                    }
                                },
                                error: function(XMLHttpRequest, textStatus, errorThrown) {
                                    $.confirm({
                                        theme: 'dark',
                                        animation: 'rotateX',
                                        closeAnimation: 'rotateX',
                                        title: false,
                                        content: textStatus,
                                        buttons: {
                                            confirm: {
                                                text: '确认',
                                                btnClass: 'waves-effect waves-button waves-light'
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    },
                    cancel: {
                        text: '取消',
                        btnClass: 'waves-effect waves-button'
                    }
                }
            });
        }
    }

    //创建车辆信息
    function createAction(){
        $("#createModal").modal("show");
    }

    //编辑车辆信息
    function updateAction() {
        var rows = $table.bootstrapTable('getSelections');
        if (rows.length == 0) {
            $.confirm({
                title: false,
                content: '请至少选择一条记录！',
                autoClose: 'cancel|3000',
                backgroundDismiss: true,
                buttons: {
                    cancel: {
                        text: '取消',
                        btnClass: 'waves-effect waves-button'
                    }
                }
            });
        } else {
            //赋初值
            var obj = rows[0];
            var carId = obj["id"];
            var carName = obj["carName"];
            var state = obj["state"];
            var carTypeId = obj["carTypeId"];

            $("#carId").val(carId);
            $("#carName").val(carName);
            $("#state").val(state);
            $("#carType").val(carTypeId);

            $("#createModal").modal("show");
            $('#createModal').on('hide.bs.modal', function () {
                $('form')[0].reset();
            });
        }
    }

</script>

<!-- 保存车辆信息模态框（Modal） -->
<div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="createModalTitle">
                    保存车辆信息
                </h4>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <input hidden id="carId" />

                    <div class="form-group">
                        <label for="carName">车辆名称</label>
                        <input type="text" class="form-control" id="carName" placeholder="车辆名称">
                    </div>

                    <div class="form-group">
                        <label for="state">车辆状态</label>
                        <select type="text" class="form-control" id="state">
                            <option value="0" selected>未出租</option>
                            <option value="1">已出租</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="carType">车辆类型</label>
                        <select type="text" class="form-control" id="carType">
                        </select>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary" id="submitbutton">
                    保存
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

</body>
</html>
